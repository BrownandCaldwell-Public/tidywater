---
title: "Helper Functions: Dose chemicals"
description: "This vignette will show how to use some of tidywater's helper functions through chemical additions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{help_functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">#"
)
library(tidywater)
library(tidyr)
library(dplyr)
library(ggplot2)
library(furrr)
library(purrr)
plan(multisession)
```

This vignette assumes a basic understanding of `define_water` and the S4 `water` class. See `vignette("intro", package = "tidywater")` for more information.

## Chemical Dosing Setup
To showcase tidywater's acid-base equilibrium functions, a common water treatment problem will be used. In this analysis, a hypothetical drinking water utility wants to know how much their pH and alkalinity will be impacted by varying doses of alum. They also want to ensure that their finished water has a pH of 8 and a minimum alkalinity of 100 mg/L as CaCO<sub>3</sub>.

We'll use tidywater's built-in water quality data, `water_df`, then apply `define_water_chain` and `balance_ions_chain` to convert the data to a `water` object. For more information on tidywater's `_chain` and `_once` functions, please see the `vignette("help_functions_blend_Waters", package = "tidywater")`. We'll also set a range of alum doses to see how they affect each water quality scenario.

```{r setup, warning=FALSE}
# Set a reange of alum doses

alum_doses <- tibble(alum = seq(5, 100, 5))

# Use tidywater's built-in data, water_df, for this example
raw <- water_df %>%
  define_water_chain() %>% 
  balance_ions_chain() %>% 
  cross_join(alum_doses)
```
## `chemdose_ph_chain`
Now that we're set up, let's dose some alum! To do this, we'll use `chemdose_ph_chain`, a function whose tidywater base is `chemdose_ph`. `chemdose_ph_chain` requires dosed chemicals to match the argument's notation. In this case, our chemical is already properly named. Other chemicals, such as caustic, ferric sulfate, soda ash and more would need to be named `naoh`, `fe2so43`, and `na2co3`, respectively.  

There are two ways to dose chemicals. 
1. You can pass an appropriately named column into the function, or 
2. You can specify the chemical in the function. 

Let's look at both options.
```{r, warning=FALSE}

# 1. Use existing column in your dataframe to dose a chemical
dose_column <- raw %>%
  chemdose_ph_chain(input_water = "balanced_water") %>% 
  pluck_water(input_water = "dosed_chem_water", parameter = "ph") %>% 
  select(-c(defined_water, balanced_water))

head(dose_column)

# 2. Dose a chemical in the function. Rename the alum column so it doesn't get used in the function
dose_argument <- raw %>%
  rename(coagulant = alum) %>% 
  chemdose_ph_chain(input_water = "balanced_water", alum = 30) %>% 
  pluck_water(input_water = "dosed_chem_water", parameter = "ph") %>% 
  select(-c(defined_water, balanced_water))


head(dose_argument)

```
For Option 1, notice that the `ph` column has a different result for each row. This shows how powerful the tidywater funcations are for simulating multiple doses for multiple scenarios.
Option 2 creates a column, `alum` to show what was dosed. This may be useful for plotting or remembering how much alum was dosed. 

## `solvedose_ph_once`
Remember, our original task is to see how alum addition affects the water's pH, but then we need the finished water to be pH = 8. First, we'll use caustic to raise the pH to 8. `solvedose_ph_once` uses `solvedose_ph` to calculate the required chemical dose (as chemical, not product) based on a target pH. 

Note: How can you remember the difference between `solvedose_ph` vs `chemdose_ph`? Any function beginning with "solve" is named for what it is solving for based on one input: SolveWhatItReturns_Input. So, `solvedose_ph` is solving for a dose based on a target pH. `solvebedlife_toc` calculates bedlife based on TOC concentrations.
Other treatment functions are set up as WhatHappensToTheWater_WhatYouSolveFor. So with `chemdose_ph`, chemicals are being dosed, and we're solving for the resulting pH. `chemdose_toc` models the resulting TOC after chemicals are added, and `ozonate_bromate` calculates bromate formation after ozonation.

Let's get back to our analysis. Similar to `chemdose_ph_chain`, `solvedose_ph_once` can handle chemical selection and target pH inputs as a column or function arguments.`solvedose_ph_once` outputs a pH, not a `water` object. Thus, `solvedose_ph_chain` doesn't exist because the `water` isn't changing, so chaining this function to a downstream tidywater function can be done using normal tidywater operations.

```{r, warning=FALSE}

# 1. Use existing columns in your dataframe to set a target pH and the chemicals to dose
raise_ph <- tibble(chemical = c("naoh", "mgoh2"),
             target_ph = c(8, 8))
solve_column <- raw %>%
  chemdose_ph_chain(input_water = "balanced_water") %>% 
  cross_join(raise_ph) %>% 
  solvedose_ph_once(input_water = "dosed_chem_water") %>% 
  select(-c(defined_water:dosed_chem_water))

head(solve_column)

# 2. Set the target pH and chemical needed to raise the pH inside the function
solve_argument <- raw %>%
  chemdose_ph_chain(input_water = "balanced_water") %>% 
  solvedose_ph_once(input_water = "dosed_chem_water", chemical = "naoh", target_ph = 8) %>% 
  select(-c(defined_water:dosed_chem_water))

head(solve_argument)

```

Now that we have the dose required to raise the pH to 8, let's dose caustic into the water!
```{r, warning=FALSE}

dosed_caustic <- raw %>%
  chemdose_ph_chain(input_water = "balanced_water", output_water = "alum_dosed") %>% 
  solvedose_ph_once(input_water = "alum_dosed", chemical = "naoh", target_ph = 8) %>% 
  rename(naoh = dose_required,
         coagulant = alum) %>% #rename alum column so it doesn't get dosed twice
  chemdose_ph_chain(input_water = "alum_dosed", output_water = "caustic_dosed") %>% 
  pluck_water(input_water = "caustic_dosed", "ph") %>% 
  select(-c(defined_water:chemical)) 

head(dosed_caustic)

```
You can see the resulting pH from dosing caustic has raised the pH to 8 +/- 0.02 SU. 

## `solvedose_alk_once`
We're not done yet! The utility has a minimum alkalinity requirement. We can use `solvedose_alk_once` in a similar manner to `solvedose_ph_once` to find how much selected chemical (soda ash for this example) is needed to get to 100 mg/L as CaCO<sub>3</sub>. 

This time though, once we have the required caustic and soda ash doses, we're going to show that `chemdose_ph_chain` can actually dose multiple chemicals at once!

```{r, warning=FALSE}

finished_water <- raw %>%
  chemdose_ph_chain(input_water = "balanced_water", output_water = "alum_dosed") %>% 
  solvedose_ph_once(input_water = "alum_dosed", chemical = "naoh", target_ph = 8) %>% 
  solvedose_alk_once(input_water = "alum_dosed", chemical = "na2co3", target_alk = 8) %>% 
  rename(naoh = dose_required,
         coagulant = alum) %>% #rename alum column so it doesn't get dosed twice
  chemdose_ph_chain(input_water = "alum_dosed", output_water = "caustic_dosed") %>% 
  pluck_water(input_water = "caustic_dosed", "ph") %>% 
  select(-c(defined_water:chemical)) 

head(dosed_caustic)

```

```{r, include = FALSE}
plan(sequential)
```